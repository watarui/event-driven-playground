# Optimized Cloud Build configuration
# Uses multi-stage builds and caching for faster builds

steps:
  # Step 1: Build the shared base image with dependencies
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--target=build'
      - '--tag=event-driven-playground-base:latest'
      - '--tag=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/event-driven-playground-base:latest'
      - '--cache-from=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/event-driven-playground-base:latest'
      - '--build-arg=BUILDKIT_INLINE_CACHE=1'
      - '--file=Dockerfile.base'
      - '.'
    id: 'build-base'

  # Step 2: Build the runtime base image
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--target=runtime'
      - '--tag=event-driven-playground-runtime:latest'
      - '--tag=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/event-driven-playground-runtime:latest'
      - '--cache-from=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/event-driven-playground-runtime:latest'
      - '--build-arg=BUILDKIT_INLINE_CACHE=1'
      - '--file=Dockerfile.base'
      - '.'
    id: 'build-runtime'
    waitFor: ['build-base']

  # Step 3: Build services in parallel using the base image
  # Command Service
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--tag=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/command-service:$SHORT_SHA'
      - '--tag=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/command-service:latest'
      - '--cache-from=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/command-service:latest'
      - '--build-arg=SERVICE_NAME=command_service'
      - '--build-arg=BUILDKIT_INLINE_CACHE=1'
      - '--file=apps/command_service/Dockerfile.optimized'
      - '.'
    id: 'build-command-service'
    waitFor: ['build-runtime']

  # Query Service
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--tag=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/query-service:$SHORT_SHA'
      - '--tag=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/query-service:latest'
      - '--cache-from=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/query-service:latest'
      - '--build-arg=SERVICE_NAME=query_service'
      - '--build-arg=BUILDKIT_INLINE_CACHE=1'
      - '--file=apps/query_service/Dockerfile.optimized'
      - '.'
    id: 'build-query-service'
    waitFor: ['build-runtime']

  # Client Service
  - name: 'gcr.io/cloud-builders/docker'
    args:
      - 'build'
      - '--tag=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/client-service:$SHORT_SHA'
      - '--tag=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/client-service:latest'
      - '--cache-from=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/client-service:latest'
      - '--build-arg=SERVICE_NAME=client_service'
      - '--build-arg=BUILDKIT_INLINE_CACHE=1'
      - '--file=apps/client_service/Dockerfile.optimized'
      - '.'
    id: 'build-client-service'
    waitFor: ['build-runtime']

# Images to push to the registry
images:
  # Base images
  - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/event-driven-playground-base:latest'
  - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/event-driven-playground-runtime:latest'
  # Service images with SHA tags
  - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/command-service:$SHORT_SHA'
  - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/command-service:latest'
  - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/query-service:$SHORT_SHA'
  - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/query-service:latest'
  - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/client-service:$SHORT_SHA'
  - 'asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/client-service:latest'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: 'E2_HIGHCPU_8'
  # Enable Docker BuildKit for better caching
  env:
    - 'DOCKER_BUILDKIT=1'
  # Use kaniko for better layer caching (optional)
  substitution_option: 'ALLOW_LOOSE'

# Shorter timeout since builds should be faster with caching
timeout: 900s

# Substitutions for versioning
substitutions:
  _REGION: 'asia-northeast1'
