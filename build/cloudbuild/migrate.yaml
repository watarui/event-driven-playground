steps:
  # マイグレーション用 Docker イメージをビルドとプッシュ（kaniko使用）
  - name: 'gcr.io/kaniko-project/executor:latest'
    id: 'build-and-push-migrate'
    args:
      - '--dockerfile=build/docker/Dockerfile.migrate'
      - '--destination=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/migrate:latest'
      - '--destination=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/migrate:$SHORT_SHA'
      - '--cache=true'
      - '--cache-ttl=168h'
      - '--compressed-caching=false'
      - '--use-new-run'
      - '--snapshot-mode=redo'

  # Cloud Run Job を作成または更新
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    id: 'deploy-job'
    waitFor: ['build-and-push-migrate']
    args:
      - 'gcloud'
      - 'run'
      - 'jobs'
      - 'update'
      - 'database-migrate'
      - '--image=asia-northeast1-docker.pkg.dev/$PROJECT_ID/event-driven-playground/migrate:latest'
      - '--region=asia-northeast1'
      - '--project=$PROJECT_ID'

options:
  logging: CLOUD_LOGGING_ONLY
  machineType: E2_HIGHCPU_8