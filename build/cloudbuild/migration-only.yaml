# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å°‚ç”¨ã® Cloud Build è¨­å®š
steps:
  # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰
  - id: 'build-migrate'
    name: 'gcr.io/kaniko-project/executor:latest'
    args:
      - '--dockerfile=build/docker/Dockerfile.migrate'
      - '--context=.'
      - '--destination=${_REGISTRY}/migrate:${SHORT_SHA}'
      - '--destination=${_REGISTRY}/migrate:latest'
      - '--cache=true'
      - '--cache-repo=${_REGISTRY}/migrate/cache'
      - '--cache-ttl=336h'  # 2é€±é–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
      - '--build-arg=MIX_ENV=prod'

  # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã®æ›´æ–°ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
  - id: 'update-migrate-job'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "${_UPDATE_JOB}" = "true" ]; then
          echo "ğŸ”„ Updating migration job..."
          gcloud run jobs update database-migrate \
            --image=${_REGISTRY}/migrate:${SHORT_SHA} \
            --region=${_REGION} \
            --project=${PROJECT_ID}
          echo "âœ… Migration job updated"
        else
          echo "â­ï¸ Skipping job update (_UPDATE_JOB=${_UPDATE_JOB})"
        fi
    waitFor: ['build-migrate']

# ãƒ“ãƒ«ãƒ‰è¨­å®š
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  dynamic_substitutions: true

# ç½®æ›å¤‰æ•°
substitutions:
  _REGISTRY: 'asia-northeast1-docker.pkg.dev/${PROJECT_ID}/event-driven-playground'
  _REGION: 'asia-northeast1'
  _UPDATE_JOB: 'false'  # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯ã‚¸ãƒ§ãƒ–ã‚’æ›´æ–°ã—ãªã„

# ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
timeout: '600s' # 10åˆ†