# マイグレーション専用の Cloud Build 設定
steps:
  # マイグレーションイメージのビルド
  - id: 'build-migrate'
    name: 'gcr.io/kaniko-project/executor:latest'
    args:
      - '--dockerfile=build/docker/Dockerfile.migrate'
      - '--context=.'
      - '--destination=${_REGISTRY}/migrate:${SHORT_SHA}'
      - '--destination=${_REGISTRY}/migrate:latest'
      - '--cache=true'
      - '--cache-repo=${_REGISTRY}/migrate/cache'
      - '--cache-ttl=336h'  # 2週間のキャッシュ
      - '--build-arg=MIX_ENV=prod'

  # マイグレーションジョブの更新（オプション）
  - id: 'update-migrate-job'
    name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        if [ "${_UPDATE_JOB}" = "true" ]; then
          echo "🔄 Updating migration job..."
          gcloud run jobs update database-migrate \
            --image=${_REGISTRY}/migrate:${SHORT_SHA} \
            --region=${_REGION} \
            --project=${PROJECT_ID}
          echo "✅ Migration job updated"
        else
          echo "⏭️ Skipping job update (_UPDATE_JOB=${_UPDATE_JOB})"
        fi
    waitFor: ['build-migrate']

# ビルド設定
options:
  machineType: 'E2_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY
  dynamic_substitutions: true

# 置換変数
substitutions:
  _REGISTRY: 'asia-northeast1-docker.pkg.dev/${PROJECT_ID}/event-driven-playground'
  _REGION: 'asia-northeast1'
  _UPDATE_JOB: 'false'  # デフォルトではジョブを更新しない

# タイムアウト設定
timeout: '600s' # 10分