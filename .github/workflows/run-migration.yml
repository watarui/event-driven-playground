name: Run Database Migration

# æ‰‹å‹•å®Ÿè¡Œå°‚ç”¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "migrate" to confirm execution'
        required: true
        default: ''
      migration_type:
        description: 'Migration type'
        required: true
        default: 'workaround'
        type: choice
        options:
          - workaround    # SQL ç›´æ¥å®Ÿè¡Œã®å›é¿ç­–ï¼ˆæ¨å¥¨ï¼‰
          - ecto          # é€šå¸¸ã® Ecto ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå•é¡Œã‚ã‚Šï¼‰
      build_new_image:
        description: 'Build new migration image before running'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'
      dry_run:
        description: 'Dry run (check only, no changes)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

env:
  PROJECT_ID: event-driven-playground-prod
  REGION: asia-northeast1

jobs:
  migrate:
    name: Run Database Migration
    runs-on: ubuntu-latest
    # "migrate" ã¨å…¥åŠ›ã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.inputs.confirm == 'migrate'
    permissions:
      contents: read
      id-token: write # Workload Identity Federation ã«å¿…è¦

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # Google Cloud èªè¨¼ï¼ˆWorkload Identity Federation ã‚’ä½¿ç”¨ï¼‰
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Cloud SDK ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ“ãƒ«ãƒ‰ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Build New Migration Image
        if: github.event.inputs.build_new_image == 'true'
        run: |
          echo "ğŸ”¨ Building new migration image..."
          gcloud builds submit \
            --config=build/cloudbuild/migration-only.yaml \
            --substitutions=SHORT_SHA=${GITHUB_SHA::7},_UPDATE_JOB=true \
            --project=${PROJECT_ID}
          echo "âœ… New migration image built and job updated"

      # ç¾åœ¨ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
      - name: Check Current Migration Status
        run: |
          echo "ğŸ” Checking current migration job status..."
          
          # æœ€æ–°ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã®æƒ…å ±ã‚’å–å¾—
          gcloud run jobs describe database-migrate \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --format="yaml" | grep -E "(image:|POOL_SIZE|DB_TIMEOUT)" | head -10 || true
          
          echo ""
          echo "ğŸ“‹ Recent migration executions:"
          gcloud run jobs executions list \
            --job=database-migrate \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --limit=5 \
            --format="table(name,status,createTime)" || true

      # Dry Run ãƒ¢ãƒ¼ãƒ‰
      - name: Dry Run Check
        if: github.event.inputs.dry_run == 'true'
        run: |
          echo "ğŸ” DRY RUN MODE - No changes will be made"
          echo ""
          echo "Migration type selected: ${{ github.event.inputs.migration_type }}"
          echo ""
          echo "Would execute: gcloud run jobs execute database-migrate"
          echo "  --region=${REGION}"
          echo "  --project=${PROJECT_ID}"
          echo "  --wait"
          
          # æœ€æ–°ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ã‚’ç¢ºèª
          echo ""
          echo "ğŸ“‹ Checking migration history in database..."
          gcloud logging read 'resource.type=cloud_run_job AND resource.labels.job_name=database-migrate AND textPayload:"Migration Summary"' \
            --limit=5 \
            --project=${PROJECT_ID} \
            --format="table(timestamp,textPayload)" | head -20 || true

      # å®Ÿéš›ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
      - name: Execute Database Migration
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo "ğŸ—„ï¸ Running database migration..."
          echo "Migration type: ${{ github.event.inputs.migration_type }}"
          
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¸ãƒ§ãƒ–ã‚’å®Ÿè¡Œ
          echo "ğŸš€ Executing migration job..."
          
          # ç’°å¢ƒå¤‰æ•°ã®ç¢ºèª
          echo "ğŸ“‹ Current environment variables:"
          echo "   - POOL_SIZE=2"
          echo "   - DB_QUEUE_TARGET=50ms"
          echo "   - DB_QUEUE_INTERVAL=100ms"
          echo "   - DB_TIMEOUT=30s"
          echo "   - DB_CONNECT_TIMEOUT=30s"
          echo "   - Migration type: ${{ github.event.inputs.migration_type }}"
          
          # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’é•·ã‚ã«è¨­å®šã—ã¦å®Ÿè¡Œ
          if gcloud run jobs execute database-migrate \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --wait \
            --timeout=600; then
            echo "âœ… Migration completed successfully"
          else
            echo "âš ï¸ Migration job failed. Checking detailed logs..."
            
            # è©³ç´°ãªãƒ­ã‚°ã‚’å–å¾—
            echo ""
            echo "ğŸ“‹ Recent error logs:"
            gcloud logging read 'resource.type=cloud_run_job AND resource.labels.job_name=database-migrate AND severity>=ERROR' \
              --limit=20 \
              --project=${PROJECT_ID} \
              --format="table(timestamp,textPayload)" | head -50 || true
            
            echo ""
            echo "ğŸ“‹ Connection errors:"
            gcloud logging read 'resource.type=cloud_run_job AND resource.labels.job_name=database-migrate AND textPayload:"connection not available"' \
              --limit=10 \
              --project=${PROJECT_ID} \
              --format="table(timestamp,textPayload)" || true
            
            # å¤±æ•—ã—ã¦ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è‡ªä½“ã¯æˆåŠŸæ‰±ã„ã«ã™ã‚‹ï¼ˆæ‰‹å‹•ç¢ºèªã®ãŸã‚ï¼‰
            echo "âŒ Migration failed - please check the logs above"
            echo "ğŸ“ You may need to use the 'workaround' migration type if timeout issues persist"
          fi

      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®çŠ¶æ…‹ç¢ºèª
      - name: Post-Migration Status
        if: github.event.inputs.dry_run == 'false'
        run: |
          echo ""
          echo "ğŸ“Š Post-migration status check..."
          
          # æœ€æ–°ã®å®Ÿè¡Œçµæœã‚’ç¢ºèª
          LATEST_EXECUTION=$(gcloud run jobs executions list \
            --job=database-migrate \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --limit=1 \
            --format="value(name)")
          
          if [ -n "$LATEST_EXECUTION" ]; then
            echo "Latest execution: $LATEST_EXECUTION"
            
            # å®Ÿè¡Œã®è©³ç´°ã‚’è¡¨ç¤º
            gcloud run jobs executions describe $LATEST_EXECUTION \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --format="yaml" | grep -E "(status:|startTime:|completionTime:|failedCount:|succeededCount:)" || true
          fi
          
          echo ""
          echo "âœ… Migration workflow completed"
          echo "ğŸ“ Please check the Cloud Run console for detailed execution logs:"
          echo "   https://console.cloud.google.com/run/jobs/detail/${REGION}/database-migrate?project=${PROJECT_ID}"

      # ã‚µãƒãƒªãƒ¼
      - name: Migration Summary
        if: always()
        run: |
          echo ""
          echo "ğŸš€ Migration Workflow Summary"
          echo "=========================="
          echo "Confirmation: ${{ github.event.inputs.confirm }}"
          echo "Migration Type: ${{ github.event.inputs.migration_type }}"
          echo "Dry Run: ${{ github.event.inputs.dry_run }}"
          echo "Region: ${REGION}"
          echo "Project: ${PROJECT_ID}"
          echo ""
          if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
            echo "âœ… Dry run completed - no changes were made"
          else
            echo "âœ… Migration workflow executed - check logs above for results"
          fi