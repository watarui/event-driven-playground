name: Deploy to Production

# main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯ãƒãƒ¼ã‚¸ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
on:
  push:
    branches:
      - main
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  PROJECT_ID: event-driven-playground-prod
  REGION: asia-northeast1
  ARTIFACT_REGISTRY: asia-northeast1-docker.pkg.dev/event-driven-playground-prod/event-driven-playground

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Workload Identity Federation ã«å¿…è¦

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # Google Cloud èªè¨¼ï¼ˆWorkload Identity Federation ã‚’ä½¿ç”¨ï¼‰
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Cloud SDK ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Docker èªè¨¼è¨­å®š
      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${REGION}-docker.pkg.dev

      # ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆCloud Build ã‚’ä½¿ç”¨ï¼‰
      - name: Build and Push Images
        run: |
          gcloud builds submit \
            --config=cloudbuild-optimized.yaml \
            --substitutions=SHORT_SHA=${GITHUB_SHA::7} \
            --project=${PROJECT_ID}

      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
      - name: Run Database Migrations
        run: |
          # Query Service ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
          gcloud run jobs execute query-service-migrate \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --wait

      # ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: Deploy Services
        run: |
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°
          IMAGE_TAG=${GITHUB_SHA::7}
          
          # Command Service
          gcloud run deploy command-service \
            --image=${ARTIFACT_REGISTRY}/command-service:${IMAGE_TAG} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --platform=managed \
            --no-traffic
          
          # Query Service
          gcloud run deploy query-service \
            --image=${ARTIFACT_REGISTRY}/query-service:${IMAGE_TAG} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --platform=managed \
            --no-traffic
          
          # Client Service
          gcloud run deploy client-service \
            --image=${ARTIFACT_REGISTRY}/client-service:${IMAGE_TAG} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --platform=managed \
            --no-traffic

      # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      - name: Health Check New Versions
        run: |
          echo "ğŸ¥ Checking health of new deployments..."
          
          # å„ã‚µãƒ¼ãƒ“ã‚¹ã®æ–°ã—ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã® URL ã‚’å–å¾—
          SERVICES=("command-service" "query-service" "client-service")
          
          for SERVICE in "${SERVICES[@]}"; do
            echo "Checking ${SERVICE}..."
            
            # æœ€æ–°ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã® URL ã‚’å–å¾—
            REVISION_URL=$(gcloud run services describe ${SERVICE} \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --format="value(status.latestCreatedRevisionName)")
            
            SERVICE_URL=$(gcloud run services describe ${SERVICE} \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --format="value(status.url)")
            
            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
            for i in {1..5}; do
              if curl -f "${SERVICE_URL}/health/ready" \
                -H "Authorization: Bearer $(gcloud auth print-identity-token)" \
                -m 10; then
                echo "âœ… ${SERVICE} is healthy"
                break
              else
                echo "â³ Waiting for ${SERVICE} to be ready (attempt $i/5)..."
                sleep 10
              fi
            done
          done

      # ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®åˆ‡ã‚Šæ›¿ãˆ
      - name: Switch Traffic
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          
          # å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆ‡ã‚Šæ›¿ãˆ
          gcloud run services update-traffic command-service \
            --to-latest \
            --region=${REGION} \
            --project=${PROJECT_ID}
          
          gcloud run services update-traffic query-service \
            --to-latest \
            --region=${REGION} \
            --project=${PROJECT_ID}
          
          gcloud run services update-traffic client-service \
            --to-latest \
            --region=${REGION} \
            --project=${PROJECT_ID}
          
          echo "âœ… Traffic switched to new version"

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®é€šçŸ¥
      - name: Deployment Summary
        if: always()
        run: |
          echo "ğŸš€ Deployment Summary"
          echo "==================="
          echo "Git SHA: ${GITHUB_SHA}"
          echo "Image Tag: ${GITHUB_SHA::7}"
          echo "Region: ${REGION}"
          echo "Project: ${PROJECT_ID}"
          
          # ã‚µãƒ¼ãƒ“ã‚¹ URL ã®è¡¨ç¤º
          echo ""
          echo "Service URLs:"
          gcloud run services list \
            --platform=managed \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --format="table(SERVICE:label='Service',URL:label='URL')"

      # Slack é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Notify Slack
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: |
            Deployment to Production: ${{ job.status }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        continue-on-error: true
