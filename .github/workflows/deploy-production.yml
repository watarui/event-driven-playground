name: Deploy to Production

# main ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¾ãŸã¯ãƒãƒ¼ã‚¸ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
on:
  push:
    branches:
      - main
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

env:
  PROJECT_ID: event-driven-playground-prod
  REGION: asia-northeast1
  ARTIFACT_REGISTRY: asia-northeast1-docker.pkg.dev/event-driven-playground-prod/event-driven-playground

jobs:
  deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write # Workload Identity Federation ã«å¿…è¦

    steps:
      # ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout repository
        uses: actions/checkout@v4

      # Google Cloud èªè¨¼ï¼ˆWorkload Identity Federation ã‚’ä½¿ç”¨ï¼‰
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      # Cloud SDK ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Docker èªè¨¼è¨­å®š
      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${REGION}-docker.pkg.dev

      # ãƒ“ãƒ«ãƒ‰ã¨ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆCloud Build ã‚’ä½¿ç”¨ - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚åŒæ™‚ãƒ“ãƒ«ãƒ‰ï¼‰
      - name: Build and Push All Images
        run: |
          echo "ğŸ”¨ Building all images including migration..."
          # Cloud Build ã‚’å®Ÿè¡Œï¼ˆãƒ­ã‚°ã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–ï¼‰
          gcloud builds submit \
            --config=build/cloudbuild/optimized.yaml \
            --substitutions=SHORT_SHA=${GITHUB_SHA::7} \
            --project=${PROJECT_ID} || true
          
          # ãƒ“ãƒ«ãƒ‰ã®å®Œäº†ã‚’å¾…ã¤
          BUILD_ID=$(gcloud builds list --limit=1 --format="value(id)" --project=${PROJECT_ID})
          echo "Waiting for build ${BUILD_ID} to complete..."
          
          # ãƒ“ãƒ«ãƒ‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
          MAX_WAIT=300  # 5åˆ†
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(gcloud builds describe ${BUILD_ID} --project=${PROJECT_ID} --format="value(status)")
            if [[ "${STATUS}" == "SUCCESS" ]]; then
              echo "âœ… Build completed successfully"
              break
            elif [[ "${STATUS}" == "FAILURE" || "${STATUS}" == "TIMEOUT" || "${STATUS}" == "CANCELLED" ]]; then
              echo "âŒ Build failed with status: ${STATUS}"
              exit 1
            else
              echo "â³ Build status: ${STATUS}. Elapsed: ${ELAPSED}s/${MAX_WAIT}s"
              sleep 5
              ELAPSED=$((ELAPSED + 5))
            fi
          done
      

      # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œ
      - name: Run Database Migrations
        run: |
          echo "ğŸ—„ï¸ Running database migrations..."
          
          # ã‚¸ãƒ§ãƒ–ã®å­˜åœ¨ç¢ºèª
          if ! gcloud run jobs describe database-migrate \
            --region=${REGION} \
            --project=${PROJECT_ID} > /dev/null 2>&1; then
            echo "âŒ Error: database-migrate job not found"
            echo "Please ensure the job is created via Terraform"
            exit 1
          fi
          
          # Job ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç¢ºèªãƒ»æ›´æ–°
          echo "ğŸ“‹ Updating job configuration..."
          gcloud run jobs update database-migrate \
            --cpu=2 \
            --memory=2Gi \
            --max-retries=1 \
            --parallelism=1 \
            --task-timeout=600 \
            --region=${REGION} \
            --project=${PROJECT_ID}
          
          # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œï¼ˆãƒ­ã‚°å‡ºåŠ›ä»˜ãï¼‰
          echo "ğŸš€ Starting migration execution..."
          EXECUTION_NAME=$(gcloud run jobs execute database-migrate \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --format="value(metadata.name)")
          
          echo "ğŸ“ Execution started: ${EXECUTION_NAME}"
          echo "â³ Waiting for completion..."
          
          # å®Ÿè¡ŒçŠ¶æ³ã‚’ç›£è¦–
          MAX_WAIT=600  # 10åˆ†
          ELAPSED=0
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            STATUS=$(gcloud run jobs executions describe ${EXECUTION_NAME} \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --format="value(status.conditions[0].type)")
            
            if [ "$STATUS" = "Completed" ]; then
              # æˆåŠŸ/å¤±æ•—ã®åˆ¤å®š
              RESULT=$(gcloud run jobs executions describe ${EXECUTION_NAME} \
                --region=${REGION} \
                --project=${PROJECT_ID} \
                --format="value(status.conditions[0].status)")
              
              if [ "$RESULT" = "True" ]; then
                echo "âœ… Migrations completed successfully"
                break
              else
                echo "âŒ Migration failed"
                echo "Fetching logs..."
                gcloud logging read "resource.type=cloud_run_job AND resource.labels.job_name=database-migrate AND labels.\"run.googleapis.com/execution_name\"=\"${EXECUTION_NAME}\"" \
                  --limit=100 \
                  --project=${PROJECT_ID} \
                  --format="table(timestamp,textPayload,jsonPayload)"
                exit 1
              fi
            else
              echo "Status: ${STATUS} (${ELAPSED}s/${MAX_WAIT}s)"
              sleep 10
              ELAPSED=$((ELAPSED + 10))
            fi
          done
          
          if [ $ELAPSED -ge $MAX_WAIT ]; then
            echo "âŒ Migration timed out after ${MAX_WAIT} seconds"
            exit 1
          fi

      # ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
      - name: Deploy Services in Parallel
        run: |
          # ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¿ã‚°
          IMAGE_TAG=${GITHUB_SHA::7}
          REVISION_TAG="sha-${IMAGE_TAG}"
          
          echo "ğŸš€ Deploying all services in parallel..."
          
          # å„ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤
          gcloud run deploy command-service \
            --image=${ARTIFACT_REGISTRY}/command-service:${IMAGE_TAG} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --platform=managed \
            --tag=${REVISION_TAG} \
            --no-traffic \
            --async &
          PID_COMMAND=$!
          
          gcloud run deploy query-service \
            --image=${ARTIFACT_REGISTRY}/query-service:${IMAGE_TAG} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --platform=managed \
            --tag=${REVISION_TAG} \
            --no-traffic \
            --async &
          PID_QUERY=$!
          
          gcloud run deploy client-service \
            --image=${ARTIFACT_REGISTRY}/client-service:${IMAGE_TAG} \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --platform=managed \
            --tag=${REVISION_TAG} \
            --no-traffic \
            --async &
          PID_CLIENT=$!
          
          # å…¨ãƒ‡ãƒ—ãƒ­ã‚¤ã®å®Œäº†ã‚’å¾…ã¤
          echo "â³ Waiting for all deployments to complete..."
          wait $PID_COMMAND $PID_QUERY $PID_CLIENT
          
          echo "âœ… All services deployed successfully"

      # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
      - name: Health Check New Versions
        run: |
          echo "ğŸ¥ Checking health of new deployments..."
          
          # å„ã‚µãƒ¼ãƒ“ã‚¹ã®æ–°ã—ã„ãƒªãƒ“ã‚¸ãƒ§ãƒ³ã® URL ã‚’å–å¾—
          SERVICES=("command-service" "query-service" "client-service")
          FAILED_SERVICES=()
          
          for SERVICE in "${SERVICES[@]}"; do
            echo "Checking ${SERVICE}..."
            
            # ã‚µãƒ¼ãƒ“ã‚¹ã® URL ã‚’å–å¾—
            SERVICE_URL=$(gcloud run services describe ${SERVICE} \
              --region=${REGION} \
              --project=${PROJECT_ID} \
              --format="value(status.url)")
            
            # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
            HEALTHY=false
            # åˆå›ã®å¾…æ©Ÿï¼ˆã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•å¾…ã¡ï¼‰
            sleep 15
            
            for i in {1..5}; do
              # å…¬é–‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆèªè¨¼ãªã—ï¼‰
              if curl -f -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/health" | grep -q "200"; then
                echo "âœ… ${SERVICE} is healthy"
                HEALTHY=true
                break
              else
                echo "â³ Waiting for ${SERVICE} to be ready (attempt $i/5)..."
                if [ $i -lt 5 ]; then
                  sleep 5  # 10ç§’ã‹ã‚‰5ç§’ã«çŸ­ç¸®
                fi
              fi
            done
            
            if [ "$HEALTHY" = false ]; then
              echo "âŒ ${SERVICE} health check failed after 5 attempts"
              FAILED_SERVICES+=("${SERVICE}")
            fi
          done
          
          # å¤±æ•—ã—ãŸã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
          if [ ${#FAILED_SERVICES[@]} -gt 0 ]; then
            echo "âŒ Health check failed for: ${FAILED_SERVICES[*]}"
            exit 1
          fi
          
          echo "âœ… All services are healthy"

      # ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
      - name: Switch Traffic in Parallel
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}
          REVISION_TAG="sha-${IMAGE_TAG}"
          
          echo "ğŸ”„ Switching traffic to new version..."
          
          # å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’ä¸¦åˆ—ã§åˆ‡ã‚Šæ›¿ãˆ
          gcloud run services update-traffic command-service \
            --to-tags=${REVISION_TAG}=100 \
            --region=${REGION} \
            --project=${PROJECT_ID} &
          PID_COMMAND=$!
          
          gcloud run services update-traffic query-service \
            --to-tags=${REVISION_TAG}=100 \
            --region=${REGION} \
            --project=${PROJECT_ID} &
          PID_QUERY=$!
          
          gcloud run services update-traffic client-service \
            --to-tags=${REVISION_TAG}=100 \
            --region=${REGION} \
            --project=${PROJECT_ID} &
          PID_CLIENT=$!
          
          # å…¨ã¦ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯åˆ‡ã‚Šæ›¿ãˆã®å®Œäº†ã‚’å¾…ã¤
          wait $PID_COMMAND $PID_QUERY $PID_CLIENT
          
          echo "âœ… Traffic switched to new version (${REVISION_TAG})"

      # ãƒ‡ãƒ—ãƒ­ã‚¤çµæœã®é€šçŸ¥
      - name: Deployment Summary
        if: always()
        run: |
          echo "ğŸš€ Deployment Summary"
          echo "==================="
          echo "Git SHA: ${GITHUB_SHA}"
          echo "Image Tag: ${GITHUB_SHA::7}"
          echo "Region: ${REGION}"
          echo "Project: ${PROJECT_ID}"
          
          # ã‚µãƒ¼ãƒ“ã‚¹ URL ã®è¡¨ç¤º
          echo ""
          echo "Service URLs:"
          gcloud run services list \
            --platform=managed \
            --region=${REGION} \
            --project=${PROJECT_ID} \
            --format="table(SERVICE:label='Service',URL:label='URL')"

